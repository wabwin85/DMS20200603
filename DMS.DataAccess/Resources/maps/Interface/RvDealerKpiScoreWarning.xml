<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="RvDealerKpiScoreWarningMap" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://ibatis.apache.org/mapping">
  <statements>
    <select id="Interface.RvDealerKpiScoreWarningMap.SelectDealerTrend" parameterClass="System.Collections.Hashtable" resultClass="System.Collections.Hashtable">
      <![CDATA[
        SELECT DP.Func_GetQuarterAdd(
                   CONVERT(INT, SUBSTRING(#YearQuarter#, 1, 4)),
                   CONVERT(INT, SUBSTRING(#YearQuarter#, 7, 1)),
                   -3
               ) Quarter1,
               DP.Func_GetQuarterAdd(
                   CONVERT(INT, SUBSTRING(#YearQuarter#, 1, 4)),
                   CONVERT(INT, SUBSTRING(#YearQuarter#, 7, 1)),
                   -2
               ) Quarter2,
               DP.Func_GetQuarterAdd(
                   CONVERT(INT, SUBSTRING(#YearQuarter#, 1, 4)),
                   CONVERT(INT, SUBSTRING(#YearQuarter#, 7, 1)),
                   -1
               ) Quarter3,
               #YearQuarter# Quarter4,
               CONVERT(
                   DECIMAL(10, 2),
                   AVG(CONVERT(DECIMAL, ISNULL(Warning.TotalScoreBack3, '0')))
               ) TotalQ1,
               CONVERT(
                   DECIMAL(10, 2),
                   AVG(CONVERT(DECIMAL, ISNULL(Warning.TotalScoreBack2, '0')))
               ) TotalQ2,
               CONVERT(
                   DECIMAL(10, 2),
                   AVG(CONVERT(DECIMAL, ISNULL(Warning.TotalScoreBack1, '0')))
               ) TotalQ3,
               CONVERT(
                   DECIMAL(10, 2),
                   AVG(CONVERT(DECIMAL, ISNULL(Warning.TotalScoreCurrent, '0')))
               ) TotalQ4
        FROM   interface.RV_DealerKPI_Score_Warning Warning
               INNER JOIN dbo.DealerMaster DealerMaster
                    ON  DealerMaster.DMA_SAP_Code = Warning.SAPID
        WHERE  DealerMaster.DMA_ID = #DealerId#
               AND Warning.[Year] = SUBSTRING(#YearQuarter#, 1, 4)
               AND Warning.Quarter = SUBSTRING(#YearQuarter#, 1, 1)
               AND Warning.DivisionID = #Bu#
      ]]>
    </select>
  </statements>
</sqlMap>
