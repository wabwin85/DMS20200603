<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="TerritoryMap" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="Territory" assembly="DMS.Model.dll" type="DMS.Model.Territory" />
    <typeAlias alias="TerritoryEx" assembly="DMS.Model.dll" type="DMS.Model.TerritoryEx" />
  </alias>
  <resultMaps>
    <resultMap id="TerritoryResult" class="Territory">
      <result property="Description" column="TER_Description" type="string" dbType="varchar"/>
      <result property="TerId" column="TER_ID" type="Guid" dbType="Guid"/>
      <result property="ParentId" column="TER_ParentID" type="Guid" dbType="Guid"/>
    </resultMap>
  </resultMaps>

  <statements>

    <select id="SelectTerritory" parameterClass="string" resultClass="Territory">
      SELECT TER_Description AS Description,TER_ID AS TerId,TER_ParentID AS ParentId
      FROM Territory
      WHERE   TER_ID = #value#
    </select>

    <select id="SelectTerritoryList" parameterClass="Territory" resultClass="Territory">
      SELECT TER_Description AS Description,TER_ID AS TerId,TER_ParentID AS ParentId
      FROM Territory WHERE TER_Description is not null
      <dynamic prepend="">
        <isNotNull prepend="AND" property="TerId">TER_ID=#TerId#</isNotNull>
        <isNotNull prepend="AND" property="ParentId">TER_ParentID=#ParentId#</isNotNull>
        <isNotNull prepend="AND" property="Description">TER_Description like '%$Description$%'</isNotNull>
      </dynamic>
    </select>

    <insert id="InsertTerritory" parameterClass="TerritoryEx">
      INSERT INTO Territory
      (TER_Description,TER_ID,TER_ParentID,TER_Type,TER_Code)
      VALUES(#Ter_Description#,#Ter_Id#,#Ter_ParentId#,#Ter_Type#,#Ter_Code#)
    </insert>

    <update id="UpdateTerritory" parameterClass="TerritoryEx">
      UPDATE Territory
      SET TER_Description=#Ter_Description#,Ter_ParentID=#Ter_ParentId#,Ter_Code=#Ter_Code#
      WHERE TER_ID = #Ter_Id#
    </update>

    <delete id="DeleteTerritory" parameterClass="string">
      DELETE FROM Territory
      WHERE TER_ID = #value#
    </delete>

    <select id="SelectFullTerritoryList" parameterClass="System.Collections.Hashtable" resultClass="System.Data.DataSet">
      SELECT [Ter_Description],[Ter_Id],[Ter_ParentId],[Ter_Code],[Ter_Type],[Ter_EName]
      ,[ProvinceId],[ProvinceCode],[ProvinceName]
      ,[CityId],[CityCode],[CityName]
      ,[CountyId],[CountyCode],[CountyName]
      ,row_number() OVER (ORDER BY ProvinceName, CityName , CountyName ) AS [row_number]
      from V_Territory WHERE TER_Description is not null
      <dynamic prepend="">
        <isNotNull prepend="AND" property="ProvinceName">ProvinceName like '%$ProvinceName$%'</isNotNull>
        <isNotNull prepend="AND" property="CityName">CityName like '%$CityName$%'</isNotNull>
        <isNotNull prepend="AND" property="CountyName">CountyName like '%$CountyName$%'</isNotNull>
      </dynamic>
    </select>
     <select id="CheckTerritoryExist" parameterClass="TerritoryEx" resultClass="TerritoryEx">
      SELECT [Ter_Description],[Ter_Id],[Ter_ParentId],[Ter_Code],[Ter_Type],[Ter_EName]
      ,[ProvinceId],[ProvinceCode],[ProvinceName]
      ,[CityId],[CityCode],[CityName]
      ,[CountyId],[CountyCode],[CountyName]      
      from V_Territory 
      WHERE   TER_Description is not null 
        and   TER_ID &lt;&gt; #Ter_Id# 
        and   Ter_Type=#Ter_Type# 
      <dynamic prepend="">
        <isNotNull prepend="AND" property="Ter_ParentId">Ter_ParentId = #Ter_ParentId#</isNotNull>
       
      </dynamic>
    </select>
    <select id="SelectFullTerritoryById" parameterClass="string" resultClass="TerritoryEx">
      SELECT [Ter_Description],[Ter_Id],[Ter_ParentId],[Ter_Code],[Ter_Type],[Ter_EName]
      ,[ProvinceId],[ProvinceCode],[ProvinceName]
      ,[CityId],[CityCode],[CityName]
      ,[CountyId],[CountyCode],[CountyName]
      ,row_number() OVER (ORDER BY ProvinceName, CityName , CountyName ) AS [row_number]
      from V_Territory
      <dynamic prepend="WHERE">
        <isParameterPresent>
          TER_ID = #value#
        </isParameterPresent>
      </dynamic>      
    </select>
  </statements>
</sqlMap>
