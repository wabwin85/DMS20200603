<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="ShipmentConsignmentMap" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://ibatis.apache.org/mapping">
  <alias>
    <typeAlias alias="ShipmentConsignment" assembly="DMS.Model.dll" type="DMS.Model.ShipmentConsignment" />
  </alias>
  <resultMaps>
    <resultMap id="ShipmentConsignmentResult" class="ShipmentConsignment">
      <result property="Id" column="SPC_ID" type="Guid" dbType="uniqueidentifier"/>
      <result property="SphId" column="SPC_SPH_ID" type="Guid" dbType="uniqueidentifier"/>
      <result property="LtmId" column="SPC_LTM_ID" type="Guid" dbType="uniqueidentifier"/>
      <result property="ShippedQty" column="SPC_ShippedQty" type="decimal" dbType="decimal"/>
      <result property="UnitPrice" column="SPC_UnitPrice" type="decimal" dbType="decimal"/>
      <result property="ShipmentDate" column="ShipmentDate" type="DateTime" dbType="datetime"/>
      <result property="Remark" column="Remark" type="string" dbType="nvarchar"/>
    </resultMap>
  </resultMaps>
  <statements>

    <select id="SelectShipmentConsignment" parameterClass="string" resultClass="ShipmentConsignment">
      SELECT SPC_ID AS Id,SPC_SPH_ID AS SphId,SPC_LTM_ID AS LtmId,SPC_ShippedQty AS ShippedQty,SPC_UnitPrice AS UnitPrice,ShipmentDate AS ShipmentDate,Remark AS Remark
      FROM ShipmentConsignment
      <dynamic prepend="WHERE">
        <isParameterPresent>
          SPC_ID = #value#
        </isParameterPresent>
      </dynamic>
    </select>
    <select id="SelectByFilterShipmentConsignment" parameterClass="ShipmentConsignment" resultClass="ShipmentConsignment">
      SELECT SPC_ID AS Id,SPC_SPH_ID AS SphId,SPC_LTM_ID AS LtmId,SPC_ShippedQty AS ShippedQty,SPC_UnitPrice AS UnitPrice,ShipmentDate AS ShipmentDate,Remark AS Remark
      FROM ShipmentConsignment
      <dynamic prepend="WHERE">
        <isNotNull prepend="AND" property="Id">SPC_ID=#Id#</isNotNull>
        <isNotNull prepend="AND" property="SphId">SPC_SPH_ID=#SphId#</isNotNull>
        <isNotNull prepend="AND" property="LtmId">SPC_LTM_ID=#LtmId#</isNotNull>
        <isNotNull prepend="AND" property="ShippedQty">SPC_ShippedQty=#ShippedQty#</isNotNull>
        <isNotNull prepend="AND" property="UnitPrice">SPC_UnitPrice=#UnitPrice#</isNotNull>
      </dynamic>
    </select>
    <insert id="InsertShipmentConsignment" parameterClass="ShipmentConsignment">
      INSERT INTO ShipmentConsignment
      (SPC_ID,SPC_SPH_ID,SPC_LTM_ID,SPC_ShippedQty,SPC_UnitPrice,ShipmentDate,Remark)
      VALUES(#Id#,#SphId#,#LtmId#,#ShippedQty#,#UnitPrice#,#ShipmentDate:DateTime:1/1/0001 12:00:00 AM#,#Remark#)
    </insert>
    <update id="UpdateShipmentConsignment" parameterClass="ShipmentConsignment">
      UPDATE ShipmentConsignment
      SET SPC_ID=#Id#,SPC_SPH_ID=#SphId#,SPC_LTM_ID=#LtmId#,SPC_ShippedQty=#ShippedQty#,SPC_UnitPrice=#UnitPrice#,ShipmentDate=#ShipmentDate#,Remark=#Remark#
      WHERE SPC_ID = #Id#
    </update>
    <delete id="DeleteShipmentConsignment" parameterClass="string">
      DELETE FROM ShipmentConsignment
      WHERE SPC_ID = #value#
    </delete>

    <delete id="DeleteShipmentConsignmentByHeaderId" parameterClass="string">
      DELETE FROM ShipmentConsignment
      WHERE SPC_SPH_ID = #value#
    </delete>


    <select id="SelectByFilterShipmentConsignmentByHeadId" parameterClass="System.Collections.Hashtable" resultClass="ShipmentConsignment">
      SELECT SC.SPC_ID AS Id,
      C.CFN_CustomerFaceNbr AS CFN,
      C.CFN_ProductLine_BUM_ID AS ProductLine,
      P.PMA_UPN AS UPN,
      LM.LTM_ID AS LotMasterId,
      LM.LTM_LotNumber AS LotNumber,
      CASE WHEN CFN_Property6='0' then CONVERT(nvarchar(6), LM.LTM_ExpiredDate, 112)
      ELSE CONVERT(varchar(100), LM.LTM_ExpiredDate, 112) end AS ExpiredDate,
      P.PMA_UnitOfMeasure AS UnitOfMeasure,
      SUM(CONVERT(decimal(18,6),LT.LOT_OnHandQty)) AS TotalQty,
      SC.SPC_UnitPrice AS UnitPrice,
      CONVERT(decimal(18,6),SC.SPC_ShippedQty) AS ShipmentQty,
      C.CFN_Implant AS Implant,
      (CASE WHEN C.CFN_Property1 = '耗材' THEN 1
      ELSE 0
      END) AS IsConsumableItem,
      PMA_ConvertFactor as ConvertFactor,
      ROW_NUMBER() OVER (ORDER BY C.CFN_CustomerFaceNbr, P.PMA_UPN, LM.LTM_LotNumber) AS row_number,
      CFN_EnglishName AS CFNEnName,
      CFN_ChineseName AS CFNChName,
      CONVERT(varchar(100), ShipmentDate, 112) ShipmentDate,
      Remark
      ,dbo.fn_GetEnabledFlag(CFN_Property6,LTM_ExpiredDate,#ShipmentDate#) IsCanOrder
      ,CFN_Property6
      FROM ShipmentConsignment SC
      INNER JOIN ShipmentHeader SH ON SC.SPC_SPH_ID = SH.SPH_ID
      INNER JOIN LotMaster LM ON SC.SPC_LTM_ID = LM.LTM_ID
      INNER JOIN Lot LT ON LM.LTM_ID = LT.LOT_LTM_ID
      INNER JOIN Product P ON LM.LTM_Product_PMA_ID = P.PMA_ID
      INNER JOIN CFN C ON P.PMA_CFN_ID = C.CFN_ID
      INNER JOIN Inventory I ON LT.LOT_INV_ID = I.INV_ID
      INNER JOIN Warehouse W ON W.WHM_ID = I.INV_WHM_ID
      WHERE W.WHM_DMA_ID = SH.SPH_Dealer_DMA_ID
      <dynamic prepend="">
        <isNotNull prepend="AND" property="HeaderId">SC.SPC_SPH_ID=#HeaderId#</isNotNull>
        <isNotNull prepend="AND" property="DealerId">SH.SPH_Dealer_DMA_ID=#DealerId#</isNotNull>
        <isNotNull prepend="AND" property="WarehouseTypes">
          W.WHM_Type IN
          <iterate  property="WarehouseTypes" open="(" close=")" conjunction=",">
            #WarehouseTypes[]#
          </iterate>
        </isNotNull>
      </dynamic>
      GROUP BY SC.SPC_ID,C.CFN_CustomerFaceNbr,C.CFN_ProductLine_BUM_ID,P.PMA_UPN,LM.LTM_ID,
      LM.LTM_LotNumber,CFN_Property6,LM.LTM_ExpiredDate,P.PMA_UnitOfMeasure,SC.SPC_UnitPrice,
      SC.SPC_ShippedQty,SC.SPC_UnitPrice,C.CFN_Implant,C.CFN_Property1,PMA_ConvertFactor,
      CFN_EnglishName,CFN_ChineseName,ShipmentDate,Remark
    </select>

    <select id="QueryShipmentConsignmentByFilter" parameterClass="System.Collections.Hashtable" resultClass="ShipmentConsignment">
      SELECT SPC_ID AS Id,SPC_SPH_ID AS SphId,SPC_LTM_ID AS LtmId,SPC_ShippedQty AS ShippedQty,SPC_UnitPrice AS UnitPrice
      FROM ShipmentConsignment
      <dynamic prepend="WHERE">
        <isNotNull prepend="AND" property="Id">SPC_ID=#Id#</isNotNull>
        <isNotNull prepend="AND" property="SphId">SPC_SPH_ID=#SphId#</isNotNull>
        <isNotNull prepend="AND" property="LtmId">SPC_LTM_ID=#LtmId#</isNotNull>
        <isNotNull prepend="AND" property="ShippedQty">SPC_ShippedQty=#ShippedQty#</isNotNull>
        <isNotNull prepend="AND" property="UnitPrice">SPC_UnitPrice=#UnitPrice#</isNotNull>
      </dynamic>
    </select>
  </statements>
</sqlMap>
