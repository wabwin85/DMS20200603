<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="TransferLineMap" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://ibatis.apache.org/mapping">
    <alias>
        <typeAlias alias="TransferLine" assembly="DMS.Model.dll" type="DMS.Model.TransferLine" />
    </alias>
    <resultMaps>
        <resultMap id="TransferLineResult" class="TransferLine">
            <result property="TrnId" column="TRL_TRN_ID" type="Guid" dbType="Guid"/>
            <result property="TransferPartPmaId" column="TRL_TransferPart_PMA_ID" type="Guid" dbType="Guid"/>
            <result property="Id" column="TRL_ID" type="Guid" dbType="Guid"/>
            <result property="FromWarehouseWhmId" column="TRL_FromWarehouse_WHM_ID" type="Guid" dbType="Guid"/>
            <result property="ToWarehouseWhmId" column="TRL_ToWarehouse_WHM_ID" type="Guid" dbType="Guid"/>
            <result property="TransferQty" column="TRL_TransferQty" type="double" dbType="double"/>
            <result property="LineNbr" column="TRL_LineNbr" type="int" dbType="Int"/>
        </resultMap>
    </resultMaps>
    <statements>

        <select id="SelectTransferLine" parameterClass="string" resultClass="TransferLine">
            SELECT TRL_TRN_ID AS TrnId,TRL_TransferPart_PMA_ID AS TransferPartPmaId,TRL_ID AS Id,TRL_FromWarehouse_WHM_ID AS FromWarehouseWhmId,TRL_ToWarehouse_WHM_ID AS ToWarehouseWhmId,TRL_TransferQty AS TransferQty,TRL_LineNbr AS LineNbr
            FROM TransferLine
            <dynamic prepend="WHERE">
                <isParameterPresent>
                    TRL_ID = #value#
                </isParameterPresent>
            </dynamic>
        </select>
        <select id="SelectByFilterTransferLine" parameterClass="TransferLine" resultClass="TransferLine">
            SELECT TRL_TRN_ID AS TrnId,TRL_TransferPart_PMA_ID AS TransferPartPmaId,TRL_ID AS Id,TRL_FromWarehouse_WHM_ID AS FromWarehouseWhmId,TRL_ToWarehouse_WHM_ID AS ToWarehouseWhmId,TRL_TransferQty AS TransferQty,TRL_LineNbr AS LineNbr
            FROM TransferLine
            <dynamic prepend="WHERE">
                <isNotNull prepend="AND" property="TrnId">TRL_TRN_ID=#TrnId#</isNotNull>
                <isNotNull prepend="AND" property="TransferPartPmaId">TRL_TransferPart_PMA_ID=#TransferPartPmaId#</isNotNull>
                <isNotNull prepend="AND" property="Id">TRL_ID=#Id#</isNotNull>
                <isNotNull prepend="AND" property="FromWarehouseWhmId">TRL_FromWarehouse_WHM_ID=#FromWarehouseWhmId#</isNotNull>
                <isNotNull prepend="AND" property="ToWarehouseWhmId">TRL_ToWarehouse_WHM_ID=#ToWarehouseWhmId#</isNotNull>
                <isNotNull prepend="AND" property="TransferQty">TRL_TransferQty=#TransferQty#</isNotNull>
                <isNotNull prepend="AND" property="LineNbr">TRL_LineNbr=#LineNbr#</isNotNull>
            </dynamic>
        </select>
        <insert id="InsertTransferLine" parameterClass="TransferLine">
            INSERT INTO TransferLine
            (TRL_TRN_ID,TRL_TransferPart_PMA_ID,TRL_ID,TRL_FromWarehouse_WHM_ID,TRL_ToWarehouse_WHM_ID,TRL_TransferQty,TRL_LineNbr)
            VALUES(#TrnId#,#TransferPartPmaId#,#Id#,#FromWarehouseWhmId#,#ToWarehouseWhmId#,#TransferQty#,#LineNbr#)
        </insert>
        <update id="UpdateTransferLine" parameterClass="TransferLine">
            UPDATE TransferLine
            SET TRL_TRN_ID=#TrnId#,TRL_TransferPart_PMA_ID=#TransferPartPmaId#,TRL_ID=#Id#,TRL_FromWarehouse_WHM_ID=#FromWarehouseWhmId#,TRL_ToWarehouse_WHM_ID=#ToWarehouseWhmId#,TRL_TransferQty=#TransferQty#,TRL_LineNbr=#LineNbr#
            WHERE TRL_ID = #Id#
        </update>
        <delete id="DeleteTransferLine" parameterClass="string">
            DELETE FROM TransferLine
            WHERE TRL_ID = #value#
        </delete>
        <delete id="DeleteTransferLineById" parameterClass="string">
            DELETE FROM TransferLine
            WHERE TRL_TRN_ID = #value#
        </delete>
        <select id="SelectByFilter" parameterClass="System.Collections.Hashtable" resultClass="TransferLine">
            SELECT TRL_TRN_ID AS TrnId,TRL_TransferPart_PMA_ID AS TransferPartPmaId,TRL_ID AS Id,TRL_FromWarehouse_WHM_ID AS FromWarehouseWhmId,TRL_ToWarehouse_WHM_ID AS ToWarehouseWhmId,TRL_TransferQty AS TransferQty,TRL_LineNbr AS LineNbr
            FROM TransferLine
            <dynamic prepend="WHERE">
                <isNotNull prepend="AND" property="TrnId">TRL_TRN_ID=#TrnId#</isNotNull>
                <isNotNull prepend="AND" property="TransferPartPmaId">TRL_TransferPart_PMA_ID=#TransferPartPmaId#</isNotNull>
                <isNotNull prepend="AND" property="FromWarehouseWhmId">TRL_FromWarehouse_WHM_ID=#FromWarehouseWhmId#</isNotNull>
                <isNotNull prepend="AND" property="ToWarehouseWhmId">TRL_ToWarehouse_WHM_ID=#ToWarehouseWhmId#</isNotNull>
            </dynamic>
        </select>
        <delete id="SelectTransferLineById" parameterClass="string" resultClass="TransferLine">
            SELECT TRL_TRN_ID AS TrnId,TRL_TransferPart_PMA_ID AS TransferPartPmaId,TRL_ID AS Id,TRL_FromWarehouse_WHM_ID AS FromWarehouseWhmId,TRL_ToWarehouse_WHM_ID AS ToWarehouseWhmId,TRL_TransferQty AS TransferQty,TRL_LineNbr AS LineNbr
            FROM TransferLine
            WHERE TRL_TRN_ID = #value#
        </delete>
        <!--added by bozhenfei on 20090824 根据经销商和物料Id查询是否有权限-->
        <!--modified by bozhenfei on 20100712 @加入授权有效期限制-->
        <select id="CheckDealerContractByPmaIdForTransfer" parameterClass="System.Collections.Hashtable" resultClass="TransferLine">
          SELECT Product.PMA_ID AS ProductId
          FROM Product
          INNER JOIN CFN ON CFN.CFN_ID = Product.PMA_CFN_ID
          INNER JOIN CfnClassification CCF ON CCF.CfnCustomerFaceNbr=CFN.CFN_CustomerFaceNbr
          WHERE Product.PMA_ID = #ProductId#
          AND (
          EXISTS ( SELECT 1
          FROM   DealerAuthorizationTable AS DA
          INNER JOIN DealerContract AS DC ON DA.DAT_DCL_ID = DC.DCL_ID
          INNER JOIN Cache_PartsClassificationRec AS CP ON CP.PCT_ProductLine_BUM_ID = DA.DAT_ProductLine_BUM_ID
          WHERE DC.DCL_DMA_ID = #DealerId#
          <!--AND CONVERT(varchar(100), GETDATE(), 112) BETWEEN CONVERT(varchar(100), DC.DCL_StartDate, 112) AND CONVERT(varchar(100), DC.DCL_StopDate, 112)-->
          AND (
          (
          DA.DAT_PMA_ID = DA.DAT_ProductLine_BUM_ID
          AND DA.DAT_ProductLine_BUM_ID = CFN.CFN_ProductLine_BUM_ID
          )
          OR (
          DA.DAT_PMA_ID != DA.DAT_ProductLine_BUM_ID
          AND CP.PCT_ParentClassification_PCT_ID = DA.DAT_PMA_ID
          AND CP.PCT_ID = CCF.ClassificationId
          )
          ) )
          )
        </select>
    </statements>
</sqlMap>
